% lualatex --shell-escape -synctex=1 -interaction=nonstopmode -file-line-error file.tex

\documentclass[a4paper,twoside]{article}

% Essential packages
\usepackage{fontspec}
\usepackage[margin=1in]{geometry}
\usepackage{fancyhdr}
\usepackage{xcolor}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{float}
\usepackage{tikz}
\usepackage{titling}
\usepackage{tocloft}
\usepackage{titletoc}
\usepackage{adjustbox}
\usepackage{etoolbox}
\usepackage[most]{tcolorbox}
\usepackage[cache=true,cachedir=.]{minted}
\usepackage[
    contentBlocks,
    rawAttribute,
    texMathDollars,
    pipeTables,
    fencedCode,
    strikeThrough,
    superscripts,
    subscripts,
    inlineNotes,
    definitionLists,
    hybrid,
    taskLists,
]{markdown}
\usepackage{endnotes}
\usepackage[normalem]{ulem}
\usepackage{soul}
\usepackage[bottom,hang]{footmisc}
\usepackage[none]{hyphenat}
\usepackage{titlesec}
\sloppy

% Configure inline code style
\definecolor{inlineCodeBg}{RGB}{246,248,250}
\definecolor{inlineCodeFg}{RGB}{36,41,47}
% Background for Markdown blockquotes
\definecolor{quoteBg}{RGB}{246,248,250}
% Footnote styling colors
\definecolor{footnoteRuleColor}{RGB}{180,180,180}
\definecolor{footnoteNumColor}{RGB}{100,100,100}
% Highlighting and strikethrough colors
\definecolor{highlightBg}{RGB}{255,255,0} % Yellow highlight
\definecolor{strikethroughColor}{RGB}{128,128,128} % Gray for strikethrough

% Styled blockquote environment using tcolorbox (no zref dependency)
\newtcolorbox{mdblockquote}{
  enhanced,
  frame hidden,
  colback=quoteBg,
  borderline west={0pt}{0pt}{gray!40},
  left=10pt,
  right=10pt,
  top=8pt,
  bottom=8pt,
  boxsep=0pt,
  sharp corners
}

\newcommand{\inlinecode}[1]{%
    \begingroup
    \setlength{\fboxsep}{2pt}%
    \colorbox{inlineCodeBg}{\ttfamily\scriptsize\color{inlineCodeFg}#1}%
    \endgroup   
}

% Custom commands for markdown extensions  
\newcommand{\mdstrikethrough}[1]{\sout{#1}}
\newcommand{\mdhighlight}[1]{\colorbox{highlightBg}{#1}}

% Checkbox commands using TikZ for better visual appearance - medium square size
\newcommand{\mdcheckboxchecked}{%
    \makebox[2.2em][l]{%
        \tikz[baseline=0.2ex]{\draw[line width=0.5pt,rounded corners=1pt] (0,0) rectangle (1.8ex,1.8ex); \draw[line width=1.4pt] (0.3ex,0.9ex) to (0.7ex,0.5ex) to (1.5ex,1.3ex);}% 
        \hspace{0.2em}% 
    }% 
}
\newcommand{\mdcheckboxunchecked}{% 
    \makebox[2.2em][l]{% 
        \tikz[baseline=0.2ex]{\draw[line width=0.5pt,rounded corners=1pt] (0,0) rectangle (1.8ex,1.8ex);}% 
        \hspace{0.2em}% 
    }% 
}

% Define code block background color
\definecolor{codeBlockBg}{RGB}{246,248,250}
\definecolor{codeBlockBorder}{RGB}{208,215,222}

% Set up markdown package to use our inline code style for backticks
\markdownSetup{
    rendererPrototypes={
        codeSpan = {\inlinecode{#1}},
        link = {\href{#2}{#1}},
        % Wrap block quotes in a gray box
        blockQuoteBegin = {\begin{mdblockquote}},
        blockQuoteEnd = {\end{mdblockquote}},        % Render HTML tags (mainly <br> tags)
        inlineHtmlTag = {%
            \ifstrequal{#1}{<br>}{\newline\noindent}{%
                \ifstrequal{#1}{<br/>}{\newline\noindent}{%
                    \ifstrequal{#1}{<br />}{\newline\noindent}{#1}% 
                }% 
            }% 
        },
        % Strikethrough text support
        strikeThrough = {\mdstrikethrough{#1}},
        % Superscript and subscript support
        superscript = {\textsuperscript{#1}},
        subscript = {\textsubscript{#1}},
        % Mark/highlight support (using == syntax if available)
        mark = {\mdhighlight{#1}},        % Configure fenced code blocks to use our custom command with tcolorbox
        % Parameters: #1=file path, #2=infostring (raw), #3=language name (processed)
        inputFencedCode = {%
            \begin{tcolorbox}[
                colback=codeBlockBg,
                colframe=codeBlockBorder,
                boxrule=0pt,
                arc=3pt,
                left=5pt,
                right=5pt,
                top=5pt,
                bottom=5pt,
                breakable
            ]% 
            \edef\templang{#3}% 
            \ifx\templang\empty%
                \inputminted[fontsize=\footnotesize,breaklines=true,linenos=false]{text}{#1}% 
            \else%
                \inputminted[fontsize=\footnotesize,breaklines=true,linenos=false]{#3}{#1}% 
            \fi%
            \end{tcolorbox}% 
        },
        % Configure indented code blocks (4 spaces) to use the same styling as fenced code blocks
        % Parameters: #1=file path
        inputVerbatim = {%
            \begin{tcolorbox}[
                colback=codeBlockBg,
                colframe=codeBlockBorder,
                boxrule=0pt,
                arc=3pt,
                left=5pt,
                right=5pt,
                top=5pt,
                bottom=5pt,
                breakable
            ]% 
            \inputminted[fontsize=\footnotesize,breaklines=true,linenos=false]{text}{#1}% 
            \end{tcolorbox}% 
        },
        % Definition list styling
        dlBegin = {\begin{description}},
        dlEnd = {\end{description}},
        dlItem = {\item[#1]},
        dlItemEnd = {}    
    },    % Enable fenced code blocks (indented code blocks handled by inputVerbatim renderer)
    fencedCode = true,
}

% Configure JetBrains Mono font
\setmonofont{JetBrainsMonoNL}[
    Path=fonts/,
    Extension=.ttf,
    UprightFont=*-Regular,
    BoldFont=*-Regular,
    ItalicFont=*-Regular,
    BoldItalicFont=*-Regular
]

% Configure hyperlinks
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=magenta,
    urlcolor=cyan
}

% Configure minted for clean styling (using default or friendly style)
\setminted{
    frame=none,
    breaklines=true,
    fontsize=\footnotesize,
    linenos=false,
    style=default
}

% Custom commands for cover page
\newcommand{\university}{@@UNIVERSITY@@}
\newcommand{\department}{@@DEPARTMENT@@}
\newcommand{\coursename}{@@SUBTITLE@@}
\newcommand{\assignmenttitle}{@@TITLE@@}
\newcommand{\submittedto}{@@SUBMITTEDTO@@}
\newcommand{\submissioninfo}[1]{
    \begin{tabular}{@{}ll@{}}
    #1
    \end{tabular}
}

\newif\ifenabletitlepage%
\enabletitlepagetrue%
@@ENABLE_TITLE_PAGE@@

% Flag to enable/disable content page; controlled via script placeholder
\newif\ifenablecontentpage%
\enablecontentpagetrue%
% If metadata has enableContentPage: false, the script leaves this blank
@@ENABLE_CONTENT_PAGE@@

% Flag to enable/disable last page credits; controlled via script placeholder
\newif\ifenablelastpagecredits%
\enablelastpagecreditstrue%
% If metadata has enableLastPageCredits: false, the script leaves this blank
@@ENABLE_LAST_PAGE_CREDITS@@

% Flag to enable/disable footnotes at end of document (true = endnotes, false = page footnotes)
\newif\ifenablefootnotesatend%
\enablefootnotesatendfalse%
% If metadata has enableFootnotesAtEnd: true, the script should add \enablefootnotesatendtrue
@@ENABLE_FOOTNOTES_AT_END@@

% Flag to enable/disable "That's all for now" page
\newif\ifenablethatsall%
\enablethatsalltrue%
% If metadata has enableThatsAllPage: false, the script leaves this blank
@@ENABLE_THATS_ALL_PAGE@@

% Configure footnote/endnote behavior based on flag
\ifenablefootnotesatend%
    % Convert footnotes to endnotes
    \let\footnote=\endnote%
    \renewcommand{\notesname}{References}
    
    % Format endnote numbers and spacing (no superscript, within margins)
    \makeatletter
    \renewcommand{\enoteformat}{%
        \noindent
        \makebox[2em][l]{\@theenmark.}\hspace{0.3em}% 
    }    \makeatother
      % Customize endnotes section appearance to match Contents style
    \renewcommand{\enoteheading}{%
        \thispagestyle{empty}
        \begin{center}
        {\Huge\bfseries\color{black}\notesname}
        \end{center}
        \vspace{\cftaftertoctitleskip}
    }
    
    % Set spacing between endnotes
    \renewcommand{\enotesize}{\normalsize}
    
    % Add spacing between endnotes
    \def\enotesize{\normalsize}
    \patchcmd{\theendnotes}{\par}{\par\vspace{0.8em}}{}{}
\else
    % Configure page footnotes styling (footmisc handles bottom placement)
    \makeatletter
    % Custom footnote rule - elegant, colored, and centered
    \renewcommand{\footnoterule}{%
        \kern-3pt
        {\color{footnoteRuleColor}\hrule width 3in height 0.8pt}
        \kern 2.5pt
    }
    
    % Spacing between multiple footnotes
    \setlength{\footnotesep}{1.2em}
    
    % Hang indent amount for wrapped footnote text
    \setlength{\footnotemargin}{1.5em}
    
    % Custom footnote mark style - small, colored numbers in brackets
    \renewcommand{\@makefnmark}{%
        \hbox{\normalfont\small\color{footnoteNumColor}[\@thefnmark]}% 
    }
    
    % Redefine footnote text formatting for better appearance
    \long\def\@makefntext#1{%
        \parindent 0em% 
        \noindent
        \makebox[0pt][r]{%
            \hspace{-1.5em}% 
            {\normalfont\small\color{footnoteNumColor}[\@thefnmark]}% 
            \hspace{0.5em}% 
        }% 
        {\footnotesize#1}% 
    }
    
    % Make footnote text slightly smaller and more refined
    \renewcommand{\footnotesize}{\fontsize{9}{11}\selectfont}
    \makeatother
\fi

% Customize Table of Contents
\renewcommand{\cfttoctitlefont}{\Huge\bfseries\color{black}}
\renewcommand{\cftbeforetoctitleskip}{20pt}
\renewcommand{\cftaftertoctitleskip}{30pt}
\renewcommand{\cftsecfont}{\Large\bfseries\color{black}}
\renewcommand{\cftsubsecfont}{\large\color{black}}
\renewcommand{\cftsubsubsecfont}{\normalsize\color{black}}
\renewcommand{\cftsecpagefont}{\Large\color{black}}
\renewcommand{\cftsubsecpagefont}{\large\color{black}}
\renewcommand{\cftsubsubsecpagefont}{\normalsize\color{black}}
\renewcommand{\cftsecleader}{\hspace{1em}}
\renewcommand{\cftsubsecleader}{\hspace{1em}}
\renewcommand{\cftsubsubsecleader}{\hspace{1em}}
\setlength{\cftbeforesecskip}{15pt}
\setlength{\cftbeforesubsecskip}{8pt}
\setlength{\cftbeforesubsubsecskip}{5pt}

% Style section titles in TOC
\titlecontents{section}[2em]
    {\addvspace{1.2pc}\large\bfseries\color{black}}
    {\contentslabel[\thecontentslabel]{2em}}
    {}
    {\hfill\thecontentspage}[\vspace{0.5pc}]

\titlecontents{subsection}[4em]
    {\addvspace{0.8pc}\normalsize\color{black}}
    {\contentslabel[\thecontentslabel]{2.5em}}
    {}
    {\hfill\thecontentspage}

\titlecontents{subsubsection}[6em]
    {\addvspace{0.5pc}\small\color{black}}
    {\contentslabel[\thecontentslabel]{3em}}
    {}
    {\hfill\thecontentspage}

% Create decorative line under TOC title
\renewcommand{\contentsname}{%
    \vspace{-20pt}%
    \centerline{\Huge\bfseries\color{black}{Contents}}%
    \vspace{10pt}%
    \centerline{\rule{0.5\textwidth}{1pt}}%
    \vspace{15pt}%
}

% Create custom title page
\renewcommand{\maketitle}{%
    \begin{titlepage}
        \centering
        \vspace*{-1cm}
        % University Logo
        \includegraphics[width=3cm]{uni-logo.pdf}\par
        \vspace{0.5cm}
        {\large\scshape \university\par}
        {\normalsize\scshape \department\par}
        \vspace{1.5cm}
        {\LARGE\bfseries \assignmenttitle\par}
        \vspace{0.3cm}
        {\color{gray}\rule{0.6\textwidth}{0.4pt}\par}
        \vspace{0.5cm}
        {\large{\coursename}\par}
        \vfill
        {
            \large
            \textbf{Submitted By}\par
            \vspace{0.3cm}
            \submissioninfo{
                @@AUTHORS@@
            }
        }
        \vfill
        {
            \large
            \textbf{Submitted To}\par
            \vspace{0.3cm}
            \submittedto\par
        }
        \vfill
        {\large @@DATE@@\par}
    \end{titlepage}
    \clearpage
}

% Configure section formatting to ensure proper spacing and line breaks
\titleformat{\section}
  {\Large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}
  {\large\bfseries}{\thesubsection}{1em}{}
\titleformat{\subsubsection}
  {\normalsize\bfseries}{\thesubsubsection}{1em}{}
\titleformat{\paragraph}
  {\normalsize\bfseries}{\theparagraph}{1em}{}
\titleformat{\subparagraph}
  {\normalsize\bfseries}{\thesubparagraph}{1em}{}

% Configure spacing around sections
\titlespacing*{\section}
  {0pt}{3.5ex plus 1ex minus .2ex}{2.3ex plus .2ex}
\titlespacing*{\subsection}
  {0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titlespacing*{\subsubsection}
  {0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titlespacing*{\paragraph}
  {0pt}{3.25ex plus 1ex minus .2ex}{1em}
\titlespacing*{\subparagraph}
  {0pt}{3.25ex plus 1ex minus .2ex}{1em}

\begin{document}
\ifenabletitlepage
\thispagestyle{empty}
\maketitle
\fi

\ifenablecontentpage
\renewcommand{\contentsname}{\centerline{Contents}}
\tableofcontents
\thispagestyle{empty}
\clearpage
\fi

\fancyhf{}% clear all
\fancyhead[LE,RO]{\thepage}
\fancyhead[LO,RE]{\leftmark}
\renewcommand{\sectionmark}[1]{\markboth{\thesection\ #1}{}}% set left mark to section title
\renewcommand{\subsectionmark}[1]{}% ignore subsections so they don't override right mark

% Activate fancy page style after title (title page stays empty)
\pagestyle{fancy}

% Prevent vertical stretching of content on short pages
\raggedbottom

% Auto-scale all tables so they never overflow the text width
\AtBeginEnvironment{tabular}{\begin{adjustbox}{max width=\textwidth}}
\AtEndEnvironment{tabular}{\end{adjustbox}}
% Auto-scale all images to fit text width
\let\oldincludegraphics\includegraphics
\renewcommand{\includegraphics}[2][]{\oldincludegraphics[width=\textwidth,#1]{#2}}

\markdownInput{@@INPUT_FILE@@}

% Print endnotes if footnotes at end is enabled
\ifenablefootnotesatend
\clearpage
\theendnotes
\fi

% "That's all for now" page (only if enabled)
\ifenablethatsall
\clearpage
\thispagestyle{empty}
\vspace*{\fill}
\begin{center}
    {\Huge\bfseries --- That's all for now ---}
\end{center}
\vspace*{\fill}
\fi

% Last page credits (only if enabled) - placed at bottom of last page
\ifenablelastpagecredits
\vfill
\begin{center}
    \footnotesize
    Carefully crafted by abd using luatex \\ 
    Visit: \href{https://abd-dev.studio/blogs/how-i-create-assignments-and-notes}{abd-dev.studio/blogs/how-i-create-assignments-and-notes} for more information \\ 
    Report errors at Email: \href{mailto:abdulrahman.abd.dev@gmail.com}{abdulrahman.abd.dev@gmail.com} \\ 
    or WhatsApp: \href{https://wa.me/923124996133}{+92 312 4996133} \\ 
\end{center}
\fi


\end{document}